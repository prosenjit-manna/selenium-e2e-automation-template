version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 24
    commands:
      - echo "=== Installing Chrome and dependencies ==="
      - curl -sS -o - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
      - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
      - apt-get update
      - apt-get install -y google-chrome-stable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1 --no-install-recommends
      - google-chrome --version
      - echo "=== Installing Firefox ==="
      - apt-get install -y firefox-esr
      - firefox --version
      - echo "=== Installing Microsoft Edge ==="
      - curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
      - install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
      - sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list'
      - rm microsoft.gpg
      - apt-get update
      - apt-get install -y microsoft-edge-stable
      - microsoft-edge --version
      - echo "=== Installing Allure ==="
      - wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
      - tar -zxvf allure-2.25.0.tgz -C /opt/
      - ln -s /opt/allure-2.25.0/bin/allure /usr/bin/allure
      - allure --version
      
  pre_build:
    commands:
      - echo Installing NPM dependencies...
      - npm install
      - echo Setting environment variables...
      - export BROWSER=chrome
      - export HEADLESS=true
      - export DISPLAY=:99
      
  build:
    commands:
      - echo Running E2E tests...
      - npm test || true
      - echo Generating Allure report...
      - npm run allure:generate || true
      
  post_build:
    commands:
      - echo Tests completed
      - echo "=== Checking environment variables ==="
      - echo "REPORT_BUCKET=${REPORT_BUCKET}"
      - echo "AWS_REGION=${AWS_REGION}"
      - echo "=== Checking generated files ==="
      - ls -la
      - echo "=== Checking allure-results ==="
      - ls -la allure-results/ || echo "No allure-results directory"
      - echo "=== Checking allure-report ==="
      - ls -la allure-report/ || echo "No allure-report directory"
      - echo "=== Checking screenshots ==="
      - ls -la screenshots/ || echo "No screenshots directory"
      - find screenshots -type f 2>/dev/null | wc -l | xargs echo "Screenshot count:"
      - echo "=== Uploading reports to S3 ==="
      - |
        if [ -d "allure-report" ]; then
          echo "Uploading allure-report..."
          aws s3 sync allure-report s3://${REPORT_BUCKET}/reports/$(date +%Y%m%d-%H%M%S)/ --region ${AWS_REGION} || echo "Failed to upload allure-report"
        else
          echo "No allure-report directory found, skipping upload"
        fi
      - |
        if [ -d "screenshots" ]; then
          FILE_COUNT=$(find screenshots -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "Found $FILE_COUNT screenshot(s), uploading..."
            aws s3 sync screenshots s3://${REPORT_BUCKET}/screenshots/$(date +%Y%m%d-%H%M%S)/ --region ${AWS_REGION} || echo "Failed to upload screenshots"
          else
            echo "Screenshots directory is empty, skipping upload"
          fi
        else
          echo "No screenshots directory found, skipping upload"
        fi

artifacts:
  files:
    - allure-results/**/*
    - allure-report/**/*
    - screenshots/**/*
  name: selenium-test-results

cache:
  paths:
    - 'node_modules/**/*'
